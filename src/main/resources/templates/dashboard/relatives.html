<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="uk">
<head>
    <meta charset="UTF-8"/>
    <title>Родичі</title>

    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f4ec; color: #2b2b2b; padding: 30px; }
        .container { max-width: 1100px; margin: 0 auto; display: flex; gap: 24px; }
        .left, .right { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .left { flex: 1; } .right { width: 420px; }

        /* Person Card Styles */
        .person-card { background: #eaf0df; padding: 14px; border-radius: 10px; margin-bottom: 12px; }
        .person-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 10px; }
        .person-info { display: flex; gap: 12px; align-items: center; }

        /* Avatar/Photo Styles */
        .avatar {
            width: 56px; height: 56px; border-radius: 50%;
            background: #cfe0b6; display: inline-block;
            object-fit: cover; border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .avatar.no-photo {
            background: #cfe0b6;
            display: flex; align-items: center; justify-content: center;
            color: #6b9b54; font-weight: bold; font-size: 18px;
        }

        .name { font-weight: 700; font-size: 16px; }
        .muted { color: #666; font-size: 13px; }

        /* Photo Management */
        .photo-section { margin-top: 8px; }
        .photo-actions { display: flex; gap: 6px; align-items: center; }
        .photo-upload { display: none; }

        /* Relatives */
        .relatives { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
        .rel-item {
            background: #d7e6c8; padding: 8px 12px; border-radius: 8px;
            display: flex; gap: 10px; align-items: center;
        }
        .rel-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        .rel-avatar.no-photo {
            background: #b8c9a9; display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 12px; font-weight: bold;
        }

        /* Buttons */
        .btn { padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; font-size: 12px; }
        .btn-primary { background: #6b9b54; color: white; }
        .btn-danger { background: #d04a4a; color: white; }
        .btn-ghost { background: transparent; border: 1px solid #ddd; color: #333; }
        .btn-small { padding: 4px 8px; font-size: 11px; }

        /* Form Styles */
        .form-row { margin-bottom: 12px; display: flex; gap: 8px; align-items: center; }
        label { font-weight: 600; font-size: 14px; min-width: 110px; }
        select, input[type="text"], input[type="number"], input[type="file"] {
            padding: 8px; border-radius: 6px; border: 1px solid #ddd; min-width: 0; width: 100%;
        }

        /* Messages */
        .message { padding: 8px; border-radius: 6px; margin-bottom: 12px; }
        .error { color: #a94442; background: #f2dede; }
        .success { color: #3c763d; background: #dff0d8; }
        .warning { color: #8a6d3b; background: #fcf8e3; }

        hr { border: none; border-top: 1px solid #eee; margin: 12px 0; }
        .top-actions { display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 12px; }

        /* Photo Preview */
        .photo-preview { margin-top: 8px; }
        .photo-preview img { max-width: 100px; max-height: 100px; border-radius: 6px; }
    </style>
</head>
<body>
<div class="container">

    <div class="left">
        <div class="top-actions">
            <a th:href="@{/dashboard/prediction}" class="btn btn-primary" title="Передбачення групи крові">
                Передбачення групи крові
            </a>
        </div>

        <h2>Ваші люди</h2>

        <!-- Messages -->
        <div th:if="${error}" class="message error" th:text="${error}"></div>
        <div th:if="${success}" class="message success" th:text="${success}"></div>
        <div th:if="${warning}" class="message warning" th:text="${warning}"></div>

        <div th:if="${#lists.isEmpty(userPersonals)}">
            <p class="muted">У вас ще немає персональних записів.</p>
        </div>

        <div th:each="p : ${userPersonals}">
            <div class="person-card">
                <!-- Person Header -->
                <div class="person-header">
                    <div class="person-info">
                        <!-- Avatar/Photo -->
                        <div th:if="${p.
hasPhoto()}">
                            <img th:src="@{/api/photos/person/{id}(id=${p.id})}"
                                 class="avatar"
                                 th:alt="${p.firstName}"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="avatar no-photo" style="display:none;"
                                 th:text="${#strings.substring(p.firstName ?: 'N', 0, 1)}">N</div>
                        </div>
                        <div th:unless="${p.hasPhoto()}" class="avatar no-photo"
                             th:text="${#strings.substring(p.firstName ?: 'N', 0, 1)}">N</div>

                        <div>
                            <div class="name" th:text="${p.firstName} + ' ' + ${p.lastName}">Ім'я Прізвище</div>
                            <div class="muted">Вік: <span th:text="${p.age}">—</span></div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display:flex; gap:8px; align-items:center;">
                        <form th:action="@{/relatives/remove}" method="post" style="display:inline;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <input type="hidden" name="personId" th:value="${p.id}"/>
                            <button type="submit" class="btn btn-danger btn-small"
                                    onclick="return confirm('Видалити цю персону?')">Видалити</button>
                        </form>

                        <a th:href="@{/relatives(userId=${userId}, selectedPersonId=${p.id})}"
                           class="btn btn-ghost btn-small">Відкрити</a>

                        <a th:href="@{/dashboard/prediction(personId=${p.id})}"
                           class="btn btn-primary btn-small">Розрахувати</a>
                    </div>
                </div>

                <!-- Photo Management -->
                <div class="photo-section">
                    <div class="photo-actions">
                        <!-- Upload Photo Button -->
                        <button type="button" class="btn btn-ghost btn-small"
                                th:onclick="'document.getElementById(\'photoUpload' + ${p.id} + '\').click()'">
                            <span th:if="${p.hasPhoto()}">Змінити фото</span>
                            <span th:unless="${p.hasPhoto()}">Додати фото</span>
                        </button>

                        <!-- Delete Photo Button (only if has photo) -->
                        <form th:if="${p.hasPhoto()}" th:action="@{/relatives/delete-photo/{id}(id=${p.id})}"
                              method="post" style="display:inline;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="btn btn-danger btn-small"
                                    onclick="return confirm('Видалити фото?')">Видалити фото</button>
                        </form>
                    </div>

                    <!-- Hidden Photo Upload Form -->
                    <form th:action="@{/relatives/upload-photo/{id}(id=${p.id})}" method="post"
                          enctype="multipart/form-data" style="display:inline;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="file" th:id="'photoUpload' + ${p.id}" name="photo"
                               accept="image/*" class="photo-upload"
                               onchange="this.form.submit()">
                    </form>
                </div>

                <!-- Relatives -->
                <div>
                    <div class="muted">Родичі:</div>
                    <div class="relatives">
                        <div th:each="r : ${p.relatives}" class="rel-item">
                            <!-- Relative Avatar -->
                            <div th:if="${r.hasPhoto()}">
                                <img th:src="@{/api/photos/person/{id}(id=${r.id})}"
                                     class="rel-avatar"
                                     th:alt="${r.firstName}"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="rel-avatar no-photo" style="display:none;"
                                     th:text="${#strings.substring(r.firstName ?: 'N', 0, 1)}">N</div>
                            </div>
                            <div th:unless="${r.hasPhoto()}" class="rel-avatar no-photo"
                                 th:text="${#strings.substring(r.firstName ?: 'N', 0, 1)}">N</div>

                            <div>
                                <strong th:text="${r.firstName} + ' ' + ${r.lastName}">Родич</strong>
                                <div class="muted" th:text="'Вік: ' + ${r.age}">age</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <hr/>
        </div>
    </div>

    <div class="right">
        <h3>Додати персону</h3>

        <a th:href="@{/user/profile}" title="Профіль"
           style="display:inline-flex; align-items:center; gap:8px; text-decoration:none;">
            <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                 style="border-radius:50%; background:#cfe0b6; padding:6px;">
                <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5z" fill="#fff"/>
                <path d="M3 20c0-3.866 3.582-7 9-7s9 3.134 9 7v1H3v-1z" fill="#fff"/>
            </svg>
        </a>

        <p class="muted">Введ
            іть дані нової персони та оберіть фото (необов'язково).</p>

        <form th:action="@{/relatives/add}" method="post" enctype="multipart/form-data">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

            <div class="form-row">
                <label for="relativeFirstName">Ім'я</label>
                <input type="text" id="relativeFirstName" name="relativeFirstName"
                       placeholder="Ім'я" required/>
            </div>

            <div class="form-row">
                <label for="relativeLastName">Прізвище</label>
                <input type="text" id="relativeLastName" name="relativeLastName"
                       placeholder="Прізвище" required/>
            </div>

            <div class="form-row">
                <label for="relativeAge">Вік</label>
                <input type="number" id="relativeAge" name="relativeAge"
                       placeholder="Вік" min="0" required/>
            </div>

            <div class="form-row">
                <label for="photo">Фото</label>
                <input type="file" id="photo" name="photo" accept="image/*"/>
            </div>

            <!-- Photo Preview -->
            <div class="photo-preview" id="photoPreview" style="display:none;">
                <img id="previewImg" src="" alt="Попередній перегляд">
            </div>

            <div style="margin-top:12px;">
                <button type="submit" class="btn btn-primary">Додати персону</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Photo preview functionality
    document.getElementById('photo').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('photoPreview');
        const previewImg = document.getElementById('previewImg');

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            preview.style.display = 'none';
        }
    });
</script>

</body>
</html>