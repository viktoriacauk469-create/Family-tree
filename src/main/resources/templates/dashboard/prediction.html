<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="uk">
<head>
    <meta charset="UTF-8"/>
    <title>Передбачення групи крові</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- CSRF meta для AJAX -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <style>
        /* Стилі (взято з твого шаблону) */
        body { font-family: Arial, sans-serif; background: #f7f4ec; color: #2b2b2b; padding: 30px; }
        .container { max-width: 1100px; margin: 0 auto; display: flex; gap: 24px; justify-content: center; }
        .card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); width: 760px; }
        h1, h2, h3 { margin: 0 0 12px 0; }
        .form-row { margin-bottom:12px; display:flex; gap:8px; align-items:center; }
        label { font-weight:600; font-size:14px; min-width:110px; }
        select, input[type="text"], input[type="number"] { padding:8px; border-radius:6px; border:1px solid #ddd; min-width:0; width:100%; }
        .small { font-size:13px; color:#666; margin-top:6px; }
        .btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
        .btn-primary { background:#6b9b54; color:white; }
        .btn-ghost { background:transparent; border:1px solid #ddd; color:#333; }
        #result table { width:100%; border-collapse:collapse; margin-top:12px;}
        #result th, #result td { border:1px solid #eee; padding:8px; text-align:left; }
        .modal { position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; }
        .modal .box { background:#fff; padding:18px; border-radius:8px; width:420px; }
    </style>
</head>
<body>
<div class="container">
    <div class="card">
        <h1>Передбачення групи крові дитини</h1>
        <p class="muted">Введіть групи батьків та резус, натисніть «Розрахувати».</p>

        <!-- Блок для передачі даних батька з сервера (Principal -> UserDTO) -->
        <!-- У контролері: model.addAttribute("user", userDTO) -->
        <div id="serverFatherData"
             th:data-blood="${user != null ? user.bloodType : ''}"
             th:data-rh="${user != null ? user.rhesusFactor : ''}"
             th:data-userid="${user != null ? user.id : ''}"></div>

        <!-- Якщо передано personId як query param (наприклад, з relatives), то контролер може додати motherPerson у модель -->
        <div id="serverMotherData"
             th:if="${motherPerson != null}"
             th:data-blood="${motherPerson.bloodType}"
             th:data-rh="${motherPerson.rhesusFactor}"
             th:data-personid="${motherPerson.id}"></div>

        <form id="bloodForm" onsubmit="return false;">
            <div class="form-row">
                <label for="fatherType">Батько</label>
                <div style="flex:1;">
                    <div style="display:flex; gap:8px;">
                        <select id="fatherType" aria-label="father-type">
                            <option value="A">II</option>
                            <option value="B">III</option>
                            <option value="AB">IV</option>
                            <option value="O">I</option>
                        </select>

                        <select id="fatherRh" aria-label="father-rh">
                            <option value="+">+</option>
                            <option value="-">-</option>
                        </select>
                    </div>
                    <div class="small">II = A, III = B, IV = AB, I = O</div>
                </div>
            </div>

            <div class="form-row">
                <label for="motherType">Мати / Партнерка</label>
                <div style="flex:1;">
                    <div style="display:flex; gap:8px;">
                        <select id="motherType" aria-label="mother-type">
                            <option value="A">II</option>
                            <option value="B">III</option>
                            <option value="AB">IV</option>
                            <option value="O">I</option>
                        </select>

                        <select id="motherRh" aria-label="mother-rh">
                            <option value="+">+</option>
                            <option value="-">-</option>
                        </select>
                    </div>
                    <div class="small">Якщо відомі точні генотипи — можна додати поле в майбутніх версіях.</div>
                </div>
            </div>

            <div style="display:flex; gap:8px; margin-top:10px;">
                <button id="calc" class="btn btn-primary">Розрахувати</button>
                <button id="reset" class="btn btn-ghost" type="button">Очистити</button>

                <!-- Кнопка: відкрити модальне вікно для відправки результату на email -->
                <button id="sendEmailBtn" class="btn btn-primary" style="margin-left:auto;">Надіслати на email</button>
            </div>
        </form>

        <div id="result" aria-live="polite" style="margin-top:14px;"></div>

        <p class="muted" style="margin-top:12px;"><em>Примітка:</em> це інформаційний калькулятор і не замінює медичну консультацію.</p>
    </div>
</div>

<!-- Просте модальне вікно для введення email -->
<div id="emailModal" class="modal" role="dialog" aria-hidden="true">
    <div class="box">
        <h3>Надіслати результат на email</h3>
        <p class="small">Введіть email отримувача:</p>
        <input id="recipientEmail" type="email" placeholder="email@example.com" style="width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:1px solid #ddd;">
        <div style="display:flex; gap:8px; justify-content:flex-end;">
            <button id="emailCancel" class="btn btn-ghost">Скасувати</button>
            <button id="emailSend" type="button" class="btn btn-primary">Надіслати</button>
        </div>
    </div>
</div>

<!-- Весь JS поміщено у th:inline="none" щоб Thymeleaf не парсив масиви/рядки -->
<script th:inline="none">
    // --- 1) Підстановка батька з даних сервера (Principal -> user.bloodType / user.rhesusFactor)
    (function () {
        const serverFather = document.getElementById('serverFatherData');
        if (serverFather) {
            const blood = serverFather.dataset.blood || '';
            const rh = serverFather.dataset.rh || '';
            const rhMapped = (rh === 'PLUS' || rh === 'plus' || rh === '+') ? '+' : (rh === 'MINUS' || rh === 'minus' || rh === '-') ? '-' : '';

            if (blood) {
                const sel = document.getElementById('fatherType');
                if (sel) sel.value = blood;
            }
            if (rhMapped) {
                const selRh = document.getElementById('fatherRh');
                if (selRh) selRh.value = rhMapped;
            }
        }

        // Якщо serverMotherData присутній — підставити маму
        const serverMother = document.getElementById('serverMotherData');
        if (serverMother) {
            const blood = serverMother.dataset.blood || '';
            const rh = serverMother.dataset.rh || '';
            const rhMapped = (rh === 'PLUS' || rh === 'plus' || rh === '+') ? '+' : (rh === 'MINUS' || rh === 'minus' || rh === '-') ? '-' : '';

            if (blood) {
                const sel = document.getElementById('motherType');
                if (sel) sel.value = blood;
            }
            if (rhMapped) {
                const selRh = document.getElementById('motherRh');
                if (selRh) selRh.value = rhMapped;
            }
        }
    })();

    // --- 2) Логіка калькулятора
    function genotypePairsFromPhenotype_ABO(phen) {
        phen = (phen || '').toUpperCase();
        if (phen === 'A') return [['A','A'], ['A','O']];
        if (phen === 'B') return [['B','B'], ['B','O']];
        if (phen === 'AB') return [['A','B']];
        if (phen === 'O') return [['O','O']];
        return [['O','O']];
    }
    function genotypePairsFromPhenotype_Rh(rh) {
        if (rh === '+') return [['D','D'], ['D','d']];
        return [['d','d']];
    }
    function combineParents(fGenotypes, mGenotypes) {
        const childABOcounts = {'A':0,'B':0,'AB':0,'O':0};
        const weightPerPair = 1/(fGenotypes.length * mGenotypes.length);
        for (const fg of fGenotypes) for (const mg of mGenotypes) {
            for (const a of fg) for (const b of mg) {
                const child = [a,b].sort().join('');
                let ph;
                if (child === 'AB') ph = 'AB';
                else if (child.includes('A') && !child.includes('B')) ph = 'A';
                else if (child.includes('B') && !child.includes('A')) ph = 'B';
                else ph = 'O';
                childABOcounts[ph] += weightPerPair * 0.25;
            }
        }
        return childABOcounts;
    }
    function combineRh(fRhGenotypes, mRhGenotypes) {
        const counts = {'+':0,'-':0};
        const weight = 1/(fRhGenotypes.length * mRhGenotypes.length);
        for (const fg of fRhGenotypes) for (const mg of mRhGenotypes) {
            for (const fa of fg) for (const ma of mg) {
                const ph = ([fa,ma].includes('D')) ? '+' : '-';
                counts[ph] += weight * 0.25;
            }
        }
        return counts;
    }

    const roman = {'A':'II','B':'III','AB':'IV','O':'I'};

    function renderResult(aboCounts, rhCounts) {
        const totalAbo = Object.values(aboCounts).reduce((s,v)=>s+v,0) || 1;
        const pct = {};
        Object.keys(aboCounts).forEach(k => { pct[k] = Math.round((aboCounts[k]/totalAbo)*1000)/10; });
        const totalRh = (rhCounts['+'] + rhCounts['-']) || 1;
        const rhPct = { '+': Math.round((rhCounts['+']/totalRh)*1000)/10, '-': Math.round((rhCounts['-']/totalRh)*1000)/10 };

        const out = document.getElementById('result');
        out.innerHTML = `
            <h3>Результат</h3>
            <table>
              <tr><th>Група крові (римська)</th><th>Ймовірність</th></tr>
              <tr><td>${roman['A']}</td><td>${pct['A']}%</td></tr>
              <tr><td>${roman['B']}</td><td>${pct['B']}%</td></tr>
              <tr><td>${roman['AB']}</td><td>${pct['AB']}%</td></tr>
              <tr><td>${roman['O']}</td><td>${pct['O']}%</td></tr>
            </table>

            <table>
              <tr><th>Rh</th><th>Ймовірність</th></tr>
              <tr><td>+</td><td>${rhPct['+']}%</td></tr>
              <tr><td>-</td><td>${rhPct['-']}%</td></tr>
            </table>
        `;
        out.dataset.abo = JSON.stringify(aboCounts);
        out.dataset.rh = JSON.stringify(rhCounts);
    }

    function clearResult() { const out = document.getElementById('result'); out.innerHTML = ''; out.dataset.abo = ''; out.dataset.rh = ''; }

    document.getElementById('calc').addEventListener('click', () => {
        const fType = document.getElementById('fatherType').value || 'O';
        const mType = document.getElementById('motherType').value || 'O';
        const fRh = document.getElementById('fatherRh').value || '+';
        const mRh = document.getElementById('motherRh').value || '+';

        const fABO = genotypePairsFromPhenotype_ABO(fType);
        const mABO = genotypePairsFromPhenotype_ABO(mType);
        const fRhG = genotypePairsFromPhenotype_Rh(fRh);
        const mRhG = genotypePairsFromPhenotype_Rh(mRh);

        const aboCounts = combineParents(fABO, mABO);
        const rhCounts = combineRh(fRhG, mRhG);

        renderResult(aboCounts, rhCounts);
    });

    document.getElementById('reset').addEventListener('click', () => {
        document.getElementById('fatherType').value = 'A';
        document.getElementById('motherType').value = 'A';
        document.getElementById('fatherRh').value = '+';
        document.getElementById('motherRh').value = '+';
        clearResult();
    });

    // --- 3) Модальне вікно та AJAX для відправки email ---
    const emailModal = document.getElementById('emailModal');
    const sendEmailBtn = document.getElementById('sendEmailBtn');
    const emailCancel = document.getElementById('emailCancel');
    const emailSend = document.getElementById('emailSend');

    sendEmailBtn.addEventListener('click', (e) => {
        e.preventDefault();
        emailModal.style.display = 'flex';
        emailModal.setAttribute('aria-hidden', 'false');
    });
    emailCancel.addEventListener('click', () => {
        emailModal.style.display = 'none';
        emailModal.setAttribute('aria-hidden', 'true');
    });

    emailSend.addEventListener('click', async () => {
        const to = document.getElementById('recipientEmail').value;
        if (!to || !to.includes('@')) {
            alert('Введіть коректний email');
            return;
        }
        const father = { bloodType: document.getElementById('fatherType').value, rh: document.getElementById('fatherRh').value };
        const mother = { bloodType: document.getElementById('motherType').value, rh: document.getElementById('motherRh').value };
        const resultEl = document.getElementById('result');
        const abo = resultEl.dataset.abo ? JSON.parse(resultEl.dataset.abo) : null;
        const rh = resultEl.dataset.rh ? JSON.parse(resultEl.dataset.rh) : null;

        const payload = {
            toEmail: to,
            father,
            mother,
            aboProbabilities: abo,
            rhProbabilities: rh
        };

        const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
        const headers = { 'Content-Type': 'application/json' };
        if (csrfTokenMeta && csrfHeaderMeta) {
            headers[csrfHeaderMeta.content] = csrfTokenMeta.content;
        }

        try {
            const resp = await fetch('/api/prediction/send', {
                method: 'POST',
                headers,
                body: JSON.stringify(payload),
            });

            if (resp.ok) {
                alert('Результат надіслано (відповідь від сервера: ' + resp.status + ')');
                emailModal.style.display = 'none';
                emailModal.setAttribute('aria-hidden', 'true');
            } else {
                const text = await resp.text();
                alert('Помилка при відправці: ' + resp.status + ' — ' + text);
            }
        } catch (err) {
            alert('Помилка мережі: ' + err.message);
        }
    });

    clearResult();

    emailSend.addEventListener('click', () => {
        const resultEl = document.getElementById('result');
        // Якщо результат ще пустий
        if(!resultEl.dataset.abo || !resultEl.dataset.rh) {
            document.getElementById('calc').click(); // автоматично розрахувати
        }

        const to = document.getElementById('recipientEmail').value;
        if (!to || !to.includes('@')) {
            alert('Введіть коректний email');
            return;
        }

        const father = { bloodType: document.getElementById('fatherType').value, rh: document.getElementById('fatherRh').value };
        const mother = { bloodType: document.getElementById('motherType').value, rh: document.getElementById('motherRh').value };
        const abo = JSON.parse(resultEl.dataset.abo);
        const rh = JSON.parse(resultEl.dataset.rh);

        const payload = { toEmail: to, father, mother, aboProbabilities: abo, rhProbabilities: rh };

        const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
        const headers = { 'Content-Type': 'application/json' };
        if (csrfTokenMeta && csrfHeaderMeta) headers[csrfHeaderMeta.content] = csrfTokenMeta.content;

        fetch('/api/prediction/send', { method:'POST', headers, body: JSON.stringify(payload) })
            .then(resp => {
                if(resp.ok) {
                    alert('Результат надіслано!');
                    emailModal.style.display = 'none';
                } else return resp.text().then(text => { throw new Error(text); });
            })
            .catch(err => alert('Помилка мережі: ' + err.message));
    });

</script>
</body>
</html>
