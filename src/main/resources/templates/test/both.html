<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="uk">
<head>
    <meta charset="UTF-8"/>
    <title>Родичі — Передбачення групи крові</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
        /* --- Загальні стилі (спадкоємні від твого шаблону) --- */
        :root{
            --bg: #f7f4ec;
            --card-bg: #fff;
            --muted: #666;
            --accent: #6b9b54;
            --danger: #d04a4a;
            --soft-green: #eaf0df;
            --chip: #d7e6c8;
            --avatar-bg: #cfe0b6;
            --text: #2b2b2b;
            --border: #eee;
            --radius: 12px;
        }

        html,body{ height:100%; }
        body {
            font-family: Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 30px;
            margin: 0;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            display: flex;
            gap: 24px;
            align-items: flex-start;
        }

        .left, .right {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .left { flex: 1; }
        .right { width: 420px; min-width: 300px; }

        h2, h3 { margin: 0 0 12px 0; }
        p.muted { color: var(--muted); margin: 0 0 12px 0; }

        .person-card {
            background: var(--soft-green);
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .person-info { display:flex; gap:12px; align-items:center; }
        .avatar {
            width:56px; height:56px; border-radius:50%; background:var(--avatar-bg); display:inline-block;
            flex-shrink:0;
        }

        .name { font-weight:700; font-size:16px; }
        .muted { color:var(--muted); font-size:13px; }

        .relatives { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
        .rel-item { background:var(--chip); padding:8px 12px; border-radius:8px; display:flex; gap:10px; align-items:center; }

        .btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
        .btn-primary { background:var(--accent); color:white; }
        .btn-danger { background:var(--danger); color:white; }
        .btn-ghost { background:transparent; border:1px solid #ddd; color:#333; }

        .form-row { margin-bottom:12px; display:flex; gap:8px; align-items:center; }
        label { font-weight:600; font-size:14px; min-width:110px; }
        select, input[type="text"], input[type="number"] {
            padding:8px; border-radius:6px; border:1px solid #ddd; min-width:0; width:100%;
        }

        .error { color:#a94442; background:#f2dede; padding:8px; border-radius:6px; margin-bottom:12px; }

        hr { border: none; border-top: 1px solid var(--border); margin: 12px 0; }

        /* --- Секція калькулятора у правій колонці --- */
        .blood-card { background: linear-gradient(180deg, #ffffff 0%, #fbfff6 100%); padding:16px; border-radius:10px; border:1px solid #f0f5ea; }
        .select-inline { display:flex; gap:8px; }
        .small { font-size:13px; color:var(--muted); margin-top:6px; }

        table.result { width:100%; border-collapse:collapse; margin-top:12px; background:transparent; }
        table.result th, table.result td { border:1px solid #f0f0f0; padding:8px; text-align:left; }
        .result .label { font-weight:700; width:70%; }

        /* Responsive */
        @media (max-width: 980px) {
            .container { flex-direction: column; padding: 16px; }
            .right { width:100%; }
        }

        /* subtle helper */
        .muted-note { font-size:13px; color:var(--muted); margin-top:8px; }
    </style>
</head>
<body>
<div class="container">

    <!-- LEFT: Список персональних записів -->
    <div class="left">
        <h2>Ваші люди</h2>

        <!-- Повідомлення про помилку -->
        <div th:if="${error}" class="error" th:text="${error}"></div>

        <!-- Якщо немає записів -->
        <div th:if="${#lists.isEmpty(userPersonals)}">
            <p class="muted">У вас ще немає персональних записів.</p>
        </div>

        <!-- Перерахунок персональних записів -->
        <div th:each="p : ${userPersonals}">
            <div class="person-card">
                <div class="person-info">
                    <span class="avatar" th:if="${p.firstName == null}"></span>
                    <div>
                        <div class="name" th:text="${p.firstName} + ' ' + ${p.lastName}">Ім'я Прізвище</div>
                        <div class="muted">Вік: <span th:text="${p.age}">—</span></div>
                    </div>
                </div>

                <!-- Кнопки праворуч -->
                <div style="display:flex; gap:8px; align-items:center;">
                    <!-- Видалити цю персону (POST) -->
                    <form th:action="@{/relatives/remove}" method="post" th:object="${p}" style="display:inline;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" name="personId" th:value="${p.id}"/>
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Видалити цю персону?')">Delete</button>
                    </form>

                    <!-- Відкрити деталі/родичів (GET) -->
                    <a th:href="@{/relatives(userId=${userId}, selectedPersonId=${p.id})}" class="btn btn-ghost">Відкрити</a>
                </div>
            </div>

            <!-- Список родичів для цієї персони (тільки відображення) -->
            <div>
                <div class="muted">Родичі:</div>
                <div class="relatives">
                    <div th:each="r : ${p.relatives}" class="rel-item">
                        <div>
                            <strong th:text="${r.firstName} + ' ' + ${r.lastName}">Родич</strong>
                            <div class="muted" th:text="${r.age}">age</div>
                        </div>
                    </div>
                </div>
            </div>

            <hr/>
        </div>

        <!-- Форма додати персону (копія з правої колонки для зручності) -->
        <h3 style="margin-top:18px;">Додати нову персону</h3>
        <p class="muted">Додай швидко людину до списку.</p>

        <form th:action="@{/relatives/add}" method="post" style="margin-top:8px;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" name="userId" th:value="${userId}"/>

            <div class="form-row">
                <label for="relativeFirstName">Ім'я</label>
                <input type="text" id="relativeFirstName" name="relativeFirstName" placeholder="Ім'я" required/>
            </div>

            <div class="form-row">
                <label for="relativeLastName">Прізвище</label>
                <input type="text" id="relativeLastName" name="relativeLastName" placeholder="Прізвище" required/>
            </div>

            <div class="form-row">
                <label for="relativeAge">Вік</label>
                <input type="number" id="relativeAge" name="relativeAge" placeholder="Вік" min="0" required/>
            </div>

            <div style="margin-top:8px;">
                <button type="submit" class="btn btn-primary">Додати персону</button>
            </div>
        </form>
    </div>

    <!-- RIGHT: Калькулятор групи крові -->
    <div class="right">
        <div class="blood-card">
            <h3>Передбачення групи крові дитини</h3>
            <p class="muted">Введіть групи батьків (позначені римськими числами) та резус, натисніть «Розрахувати».</p>

            <form id="bloodForm" onsubmit="return false;">
                <div class="form-row">
                    <label>Батько</label>
                    <div style="flex:1;">
                        <div class="select-inline">
                            <select id="fatherType" aria-label="father-type">
                                <!-- value — внутрішня буква, текст — римська позначка -->
                                <option value="A">II</option>
                                <option value="B">III</option>
                                <option value="AB">IV</option>
                                <option value="O">I</option>
                            </select>
                            <select id="fatherRh" aria-label="father-rh">
                                <option value="+">+</option>
                                <option value="-">-</option>
                            </select>
                        </div>
                        <div class="small">II = A, III = B, IV = AB, I = O</div>
                    </div>
                </div>

                <div class="form-row">
                    <label>Мати / Партнерка</label>
                    <div style="flex:1;">
                        <div class="select-inline">
                            <select id="motherType" aria-label="mother-type">
                                <option value="A">II</option>
                                <option value="B">III</option>
                                <option value="AB">IV</option>
                                <option value="O">I</option>
                            </select>
                            <select id="motherRh" aria-label="mother-rh">
                                <option value="+">+</option>
                                <option value="-">-</option>
                            </select>
                        </div>
                        <div class="small">Якщо відоме точне генотипове позначення — його можна врахувати в майбутніх версіях.</div>
                    </div>
                </div>

                <div style="display:flex; gap:8px; margin-top:10px;">
                    <button id="calc" class="btn btn-primary">Розрахувати</button>
                    <button id="reset" class="btn btn-ghost" type="button">Очистити</button>
                </div>
            </form>

            <div id="result" aria-live="polite" style="margin-top:14px;">
                <!-- Результат зʼявиться тут -->
            </div>

            <p class="muted-note">Примітка: це інформаційний калькулятор, не замінює медичну консультацію.</p>
        </div>
    </div>
</div>

<!-- --- Логіка JS (клієнтська) --- -->
<script>
    /* --- Генетична логіка (працює з A/B/AB/O всередині) --- */
    function genotypePairsFromPhenotype_ABO(phen) {
        phen = (phen || '').toUpperCase();
        if (phen === 'A') return [['A','A'], ['A','O']];
        if (phen === 'B') return [['B','B'], ['B','O']];
        if (phen === 'AB') return [['A','B']];
        if (phen === 'O') return [['O','O']];
        return [['O','O']];
    }
    function genotypePairsFromPhenotype_Rh(rh) {
        if (rh === '+') return [['D','D'], ['D','d']];
        return [['d','d']];
    }

    function combineParents(fGenotypes, mGenotypes) {
        const childABOcounts = {'A':0,'B':0,'AB':0,'O':0};
        const weightPerPair = 1/(fGenotypes.length * mGenotypes.length);

        for (const fg of fGenotypes) {
            for (const mg of mGenotypes) {
                for (const a of fg) {
                    for (const b of mg) {
                        const child = [a,b].sort().join('');
                        let ph;
                        if (child === 'AB') ph = 'AB';
                        else if (child.includes('A') && !child.includes('B')) ph = 'A';
                        else if (child.includes('B') && !child.includes('A')) ph = 'B';
                        else ph = 'O';
                        childABOcounts[ph] += weightPerPair * 0.25;
                    }
                }
            }
        }
        return childABOcounts;
    }

    function combineRh(fRhGenotypes, mRhGenotypes) {
        const counts = {'+':0,'-':0};
        const weight = 1/(fRhGenotypes.length * mRhGenotypes.length);
        for (const fg of fRhGenotypes) {
            for (const mg of mRhGenotypes) {
                for (const fa of fg) {
                    for (const ma of mg) {
                        const ph = ([fa,ma].includes('D')) ? '+' : '-';
                        counts[ph] += weight * 0.25;
                    }
                }
            }
        }
        return counts;
    }

    // Римська мапа для відображення
    const roman = {'A':'II','B':'III','AB':'IV','O':'I'};

    // UI helpers
    function renderResult(aboCounts, rhCounts) {
        // Нормалізувати суму (має бути 1)
        const totalAbo = Object.values(aboCounts).reduce((s,v)=>s+v,0) || 1;
        const pct = {};
        Object.keys(aboCounts).forEach(k => {
            pct[k] = Math.round((aboCounts[k]/totalAbo)*1000)/10; // 1 знак
        });
        const totalRh = (rhCounts['+'] + rhCounts['-']) || 1;
        const rhPct = {
            '+': Math.round((rhCounts['+']/totalRh)*1000)/10,
            '-': Math.round((rhCounts['-']/totalRh)*1000)/10
        };

        const out = document.getElementById('result');
        out.innerHTML = `
            <h4 style="margin:0 0 8px 0;">Результат</h4>
            <table class="result" aria-label="results">
                <tr><th class="label">Група крові (римська)</th><th>Ймовірність</th></tr>
                <tr><td>${roman['A']}</td><td>${pct['A']}%</td></tr>
                <tr><td>${roman['B']}</td><td>${pct['B']}%</td></tr>
                <tr><td>${roman['AB']}</td><td>${pct['AB']}%</td></tr>
                <tr><td>${roman['O']}</td><td>${pct['O']}%</td></tr>
            </table>

            <table class="result" style="margin-top:8px;" aria-label="rh-results">
                <tr><th class="label">Rh</th><th>Ймовірність</th></tr>
                <tr><td>+</td><td>${rhPct['+']}%</td></tr>
                <tr><td>-</td><td>${rhPct['-']}%</td></tr>
            </table>
        `;
    }

    function clearResult() {
        document.getElementById('result').innerHTML = '';
    }

    // Event handlers
    document.getElementById('calc').addEventListener('click', () => {
        const fType = document.getElementById('fatherType').value || 'O';
        const mType = document.getElementById('motherType').value || 'O';
        const fRh = document.getElementById('fatherRh').value || '+';
        const mRh = document.getElementById('motherRh').value || '+';

        const fABO = genotypePairsFromPhenotype_ABO(fType);
        const mABO = genotypePairsFromPhenotype_ABO(mType);
        const fRhG = genotypePairsFromPhenotype_Rh(fRh);
        const mRhG = genotypePairsFromPhenotype_Rh(mRh);

        const aboCounts = combineParents(fABO, mABO);
        const rhCounts = combineRh(fRhG, mRhG);

        renderResult(aboCounts, rhCounts);
    });

    document.getElementById('reset').addEventListener('click', () => {
        document.getElementById('fatherType').value = 'A';
        document.getElementById('motherType').value = 'A';
        document.getElementById('fatherRh').value = '+';
        document.getElementById('motherRh').value = '+';
        clearResult();
    });

    // Ініціалізація: пустий результат
    clearResult();
</script>
</body>
</html>
