<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="uk">
<head>
    <meta charset="UTF-8"/>
    <title>Підтвердження пошти</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>

    <!-- Якщо в модель передано success — через 2s редірект на головну -->
<!--    <meta th:if="${success}" http-equiv="refresh" content="2;url=/" />-->

    <style>
        :root{
            --bg:#fbf6ee;
            --card:#fffaf6;
            --accent:#6b9b54;
            --muted:#6b6b6b;
            --input-bg:#d9e6b8;
            --danger:#c84b4b;
            --success-bg:#e9f7ec;
        }

        html,body{
            height:100%;
            margin:0;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: var(--bg);
            color: #222;
        }

        /* Центрування сторінки */
        .page {
            min-height:100%;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:40px 18px;
        }

        /* Карточка */
        .card {
            width:100%;
            max-width:640px;              /* ширша картка для десктопу */
            background: var(--card);
            border-radius:18px;
            padding:36px;
            box-shadow: 0 10px 40px rgba(30,30,30,0.06);
            box-sizing:border-box;
        }

        h1 {
            margin:0;
            font-size:30px;
            font-weight:800;
            text-align:center;
            color:#111;
        }

        p.lead {
            margin:8px 0 22px;
            color:var(--muted);
            text-align:center;
            font-size:15px;
        }

        .messages { max-width:520px; margin:0 auto 12px; text-align:center; }
        .success { background:var(--success-bg); color:#1f6d36; padding:10px 14px; border-radius:10px; display:inline-block; }
        .error { background:#fff0f0; color:var(--danger); padding:10px 14px; border-radius:10px; display:inline-block; }

        /* Контент форми: центруємо і обмежуємо ширину внутрішніх елементів */
        .form-inner {
            max-width:520px;
            margin: 0 auto;
        }

        /* Блок з комірками коду */
        .code-inputs {
            display:flex;
            gap:12px;
            justify-content:center;
            align-items:center;
            margin: 8px 0 6px;
            flex-wrap:wrap;
        }

        .digit {
            width:64px;
            height:64px;
            border-radius:12px;
            border: none;
            background: var(--input-bg);
            text-align:center;
            font-weight:700;
            font-size:26px;
            outline: none;
            box-shadow: inset 0 -2px 0 rgba(0,0,0,0.03);
            transition: transform .08s, box-shadow .12s;
        }

        .digit:focus {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }

        /* Менший розмір полів на мобільних */
        @media (max-width:420px){
            .digit { width:48px; height:48px; font-size:20px; gap:8px; }
            .card { padding:22px; border-radius:14px; }
            h1 { font-size:22px; }
        }

        .hint {
            text-align:center;
            color:var(--muted);
            font-size:13px;
            margin-top:6px;
        }

        .btn {
            display:block;
            width:100%;
            max-width:360px;
            margin:18px auto 6px;
            padding:12px 16px;
            border-radius:14px;
            border:none;
            background:var(--accent);
            color:white;
            font-weight:700;
            cursor:pointer;
            font-size:15px;
            box-shadow: 0 6px 18px rgba(107,155,84,0.18);
        }

        .links {
            text-align:center;
            margin-top:12px;
            color:var(--muted);
            font-size:14px;
        }

        .links a { color:var(--accent); text-decoration:none; font-weight:600; }

        /* Додаткові стилі для пом'якшення вигляду інпутів при вставці/disabled */
        .digit[disabled] { opacity:0.6; cursor:not-allowed; }
    </style>
</head>
<body>
<div class="page">
    <div class="card" role="main" aria-labelledby="verify-title">
        <h1 id="verify-title">Підтвердження пошти</h1>
        <p class="lead">Ми надіслали вам код — введіть його в 6 полів нижче</p>

        <div class="messages">
            <div th:if="${success}" class="success" th:text="${success}">Пошта підтверджена. Ви будете перенаправлені...</div>
            <div th:if="${error}" class="error" th:text="${error}">Невірний код або помилка.</div>
        </div>

        <div class="form-inner">
            <form th:action="@{/verify}" method="post" id="verifyForm" onsubmit="return prepareAndSubmit(event)">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <!-- Передаємо email приховано (контролер повинен покласти його в модель) -->
                <input type="hidden" name="email" th:value="${email}" />

                <!-- Зібраний код -->
                <input type="hidden" name="code" id="codeCombined" />

                <div class="code-inputs" role="group" aria-label="verification code">
                    <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="digit" id="c1" autocomplete="one-time-code" aria-label="Digit 1" />
                    <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="digit" id="c2" autocomplete="one-time-code" aria-label="Digit 2" />
                    <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="digit" id="c3" autocomplete="one-time-code" aria-label="Digit 3" />
                    <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="digit" id="c4" autocomplete="one-time-code" aria-label="Digit 4" />
                    <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="digit" id="c5" autocomplete="one-time-code" aria-label="Digit 5" />
                    <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="digit" id="c6" autocomplete="one-time-code" aria-label="Digit 6" />
                </div>

                <div class="hint">Введіть 6-значний код</div>

                <button type="submit" class="btn">Підтвердити</button>
            </form>

            <div class="links">
                <span>Повернутись до </span><a th:href="@{/login}">входу</a>
            </div>
        </div>
    </div>
</div>

<script>
    // Покращена логіка вводу: автоперехід, backspace, вставка, збір коду
    (function () {
        const inputs = Array.from(document.querySelectorAll('.digit'));
        if (!inputs.length) return;

        // focus на першу пусту інпуту
        const setInitialFocus = () => {
            const firstEmpty = inputs.find(i => !i.value);
            (firstEmpty || inputs[0]).focus();
        };

        setInitialFocus();

        inputs.forEach((input, idx) => {
            input.addEventListener('input', (e) => {
                const cleaned = input.value.replace(/\D/g, '').slice(0,1);
                input.value = cleaned;

                if (cleaned && idx < inputs.length - 1) {
                    inputs[idx + 1].focus();
                }

                // оновлюємо приховане поле
                document.getElementById('codeCombined').value = inputs.map(i => i.value || '').join('');
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace') {
                    if (input.value === '' && idx > 0) {
                        inputs[idx - 1].focus();
                        // prevent default so browser doesn't navigate back in some contexts
                        e.preventDefault();
                    }
                } else if (e.key === 'ArrowLeft' && idx > 0) {
                    inputs[idx - 1].focus();
                    e.preventDefault();
                } else if (e.key === 'ArrowRight' && idx < inputs.length - 1) {
                    inputs[idx + 1].focus();
                    e.preventDefault();
                }
            });

            // Paste: якщо вставлено більше ніж 1 символ — розподілити
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text') || '';
                const digits = text.replace(/\D/g, '').slice(0, inputs.length).split('');
                if (!digits.length) return;
                digits.forEach((d, i) => inputs[i].value = d);
                document.getElementById('codeCombined').value = inputs.map(i => i.value || '').join('');
                // focus на наступне після останнього вставленого, або на кнопку
                const last = Math.min(digits.length, inputs.length) - 1;
                if (last >= 0 && last < inputs.length - 1) inputs[last + 1].focus();
            });
        });
    })();

    function prepareAndSubmit(event) {
        const inputs = Array.from(document.querySelectorAll('.digit'));
        const code = inputs.map(i => i.value || '').join('');
        if (code.length !== 6) {
            event.preventDefault();
            // м'яке повідомлення замість alert
            const firstEmpty = inputs.find(i => !i.value);
            if (firstEmpty) firstEmpty.focus();
            // невелике вікно помилки
            const prevError = document.querySelector('.messages .error');
            if (!prevError) {
                const msg = document.createElement('div');
                msg.className = 'error';
                msg.textContent = 'Введіть 6-значний код підтвердження.';
                document.querySelector('.messages').appendChild(msg);
                setTimeout(() => msg.remove(), 2500);
            }
            return false;
        }
        document.getElementById('codeCombined').value = code;
        return true;
    }
</script>
</body>
</html>
